import sqlite3 from "sqlite3";
import { Database } from "sqlite3";
import path from "path";
import fs from "fs";

class DatabaseManager {
  private db: Database;

  constructor() {
    const dbPath = path.join(__dirname, "../../medical.db");
    this.db = new sqlite3.Database(dbPath);
    this.initDatabase();
  }

  private initDatabase() {
    const initSQL = fs.readFileSync(path.join(__dirname, "init.sql"), "utf-8");
    this.db.exec(initSQL, (err) => {
      if (err) {
        console.error("Error initializing database:", err);
      } else {
        console.log("Database initialized successfully");
        this.seedData();
      }
    });
  }

  private seedData() {
    // Добавляем тестовые данные
    const seedSQL = `
      -- Departments
      INSERT OR IGNORE INTO departments (id, name, head_doctor, contact_info) VALUES
      ('dept-1', 'Кардиологическое отделение', 'Иванов Игорь Викторович', '+1234567890'),
      ('dept-2', 'Неврологическое отделение', 'Смирнов Николай Львович', '+1236787891'),
      ('dept-3', 'Педиатрическое отделение', 'Богданов Андрей Егорович', '+1444567592'),
      ('dept-4', 'Реанимационное отделение', 'Краснова Екатерина Васильевна', '+1237837892'),
      ('dept-5', 'Хирургическое отделение', 'Курочкина Елизавета Даниловна', '+1234564912');

      -- Disease Categories
      INSERT OR IGNORE INTO disease_categories (id, name) VALUES
      ('cat-1', 'Кардиологические'),
      ('cat-2', 'Неврологические'),
      ('cat-3', 'Педиатрические'),
      ('cat-4', 'Реанимационные'),
      ('cat-5', 'Хирургические');

      -- Disease Complexity
      INSERT OR IGNORE INTO disease_complexity (id, description) VALUES
      ('comp-1', 'Низкая сложность'),
      ('comp-2', 'Средняя сложность'),
      ('comp-3', 'Высокая сложность');

      -- Diseases
      INSERT OR IGNORE INTO diseases (id, name, category_id, complexity_id) VALUES
      ('dis-1', 'Гипертензия I стадии', 'cat-1', 'comp-1'),
      ('dis-2', 'Синусовая такихардия', 'cat-1', 'comp-1'),
      ('dis-3', 'Гипертония', 'cat-1', 'comp-2'),
      ('dis-4', 'Хроническая сердечная недостаточность I-II', 'cat-1', 'comp-2'),
      ('dis-5', 'Острый инфаркт миокарда', 'cat-1', 'comp-3'),
      ('dis-6', 'Тромбоэмболия легочной артерии высокого риска', 'cat-1', 'comp-3'),
      ('dis-7', 'Мигрень', 'cat-2', 'comp-1'),
      ('dis-8', 'Синдром запястного канала', 'cat-2', 'comp-1'),
      ('dis-9', 'Рассеянный склероз в стадии ремиссии', 'cat-2', 'comp-2'),
      ('dis-10', 'Мигрень с аурой', 'cat-2', 'comp-2'),
      ('dis-11', 'Геморрагический инсульт с прорывом крови в желудочки мозга', 'cat-2', 'comp-3'),
      ('dis-12', 'Эпилептический статус', 'cat-2', 'comp-2'),
      ('dis-13', 'Ветряная оспа', 'cat-3', 'comp-1'),
      ('dis-14', 'ОРВИ', 'cat-3', 'comp-1'),
      ('dis-15', 'Бронхиальная астма легкой и средней степени тяжести', 'cat-3', 'comp-2'),
      ('dis-16', 'Сахарный диабет 1 типа', 'cat-3', 'comp-3'),
      ('dis-17', 'Острая дыхательная недостаточность', 'cat-4', 'comp-1'),
      ('dis-18', 'Септический шок', 'cat-4', 'comp-2'),
      ('dis-19', 'Кардиогенный шок', 'cat-4', 'comp-3'),
      ('dis-20', 'Удаление поверхностных новообразований кожи', 'cat-5', 'comp-1'),
      ('dis-21', 'Холецистэктомия при остром холецистите без осложнений', 'cat-5', 'comp-2'),
      ('dis-22', 'Эндартерэктомия при стенозе сонной артерии', 'cat-5', 'comp-2'),
      ('dis-23', 'Трансплантация печени', 'cat-5', 'comp-3');

      -- Employees
      INSERT OR IGNORE INTO employees (id, full_name, position, department_id, contact_info, education, specialization) VALUES
      ('emp-1', 'Иванов Игорь Викторович', 'Главный врач', 'dept-1', 'ivanov@hospital.com', 'Московский государственный медико-стоматологический университет им. А.И. Евдокимова (МГМСУ), Кардиология, интервенционная кардиология', 'Кардиология'),
      ('emp-2', 'Васильева Елена Михайловна', 'Старший врач', 'dept-1', 'vasilieva@hospital.com', 'Первый Санкт-Петербургский государственный медицинский университет им. И.П. Павлова (ПСПбГМУ), Кардиология', 'Кардиология, аритмология'),
      ('emp-3', 'Кузнецов Дмитрий Игоревич', 'Врач', 'dept-1', 'kuznetsov@hospital.com', 'Казанский государственный медицинский университет (КГМУ), Кардиология', 'Кардиология, эхокардиография'),
      ('emp-4', 'Смирнов Николай Львович', 'Главный врач', 'dept-2', ' smirnov@hospital.com', 'Российский национальный исследовательский медицинский университет имени Н.И. Пирогова (РНИМУ), Неврология', 'Неврология, сосудистая неврология'),
      ('emp-5', 'Пирогов Сергей Петрович', 'Старший врач', 'dept-2', 'pirogov@hospital.com', 'Сибирский государственный медицинский университет (СибГМУ), Неврология', 'Неврология, эпилептология'),
      ('emp-6', 'Михайлова Анна Владимировна', 'Врач', 'dept-2', 'mikhailova@hospital.com', 'Самарский государственный медицинский университет (СамГМУ), Неврология', 'Неврология, нейрореабилитация'),
      ('emp-7', 'Богданов Андрей Егорович', 'Главный врач', 'dept-3', 'bogdanov@hospital.com', 'Российский государственный медицинский университет (РГМУ), Педиатрия', 'Педиатрия'),
      ('emp-8', 'Лебедев Алексей Николаевич', 'Старший врач', 'dept-3', 'lebedev@hospital.com', 'Воронежский государственный медицинский университет имени Н.Н. Бурденко (ВГМУ), Педиатрия', 'Педиатрия, детская кардиология'),
      ('emp-9', 'Новикова Екатерина Сергеевна', 'Врач', 'dept-3', 'novikova@hospital.com', 'Алтайский государственный медицинский университет (АГМУ), Педиатрия', 'Педиатрия, детская пульмонология'),
      ('emp-10', 'Краснова Екатерина Васильевна', 'Главный врач', 'dept-4', 'krasnova@hospital.com', 'Первый Московский государственный медицинский университет имени И.М. Сеченова (Сеченовский университет), Анестезиология-реаниматология', 'Анестезиология-реаниматология'),
      ('emp-11', 'Зайцева Марина Олеговна', 'Старший врач', 'dept-4', 'zaytseva@hospital.com', 'Уральский государственный медицинский университет (УГМУ), Анестезиология-реаниматология', 'Анестезиология-реаниматология, экстракорпоральная мембранная оксигенация'),
      ('emp-12', 'Федоров Андрей Михайлович', 'Врач', 'dept-4', 'fedorov@hospital.com', 'Красноярский государственный медицинский университет имени профессора В.Ф. Войно-Ясенецкого (КрасГМУ), Анестезиология-реаниматология', 'Анестезиология-реаниматология, респираторная поддержка'),
      ('emp-13', 'Курочкина Елизавета Даниловна', 'Главный врач', 'dept-5', 'kurochkina@hospital.com', 'Санкт-Петербургский государственный педиатрический медицинский университет (СПбГПМУ), Хирургия', 'Общая хирургия, лапароскопическая хирургия'),
      ('emp-14', 'Павлова Светлана Викторовна', 'Старший врач', 'dept-5', 'pavlova@hospital.com', 'Саратовский государственный медицинский университет имени В.И. Разумовского (СГМУ), Хирургия', 'Хирургия, колопроктология'),
      ('emp-15', 'Николаев Игорь Сергеевич', 'Врач', 'dept-5', 'nikolaev@hospital.com', 'Тихоокеанский государственный медицинский университет (ТГМУ), Хирургия', 'Хирургия, сосудистая хирургия');

      -- Wards
      INSERT OR IGNORE INTO wards (id, number, department_id, bed_count) VALUES
      ('ward-1', '101', 'dept-1', 4),
      ('ward-2', '201', 'dept-2', 6),
      ('ward-3', '301', 'dept-3', 4),
      ('ward-4', '401', 'dept-4', 8),
      ('ward-5', '501', 'dept-5', 8);

      -- Patients
      INSERT OR IGNORE INTO patients (id, full_name, birth_date, gender, contact_info, ward_id, attending_doctor_id, registration_date, disease_id) VALUES
      ('pat-1', 'Богданов Марк Егорович', '1985-05-15', 'Мужчина', 'bogdanov@email.com', 'ward-1', 'emp-1', '2024-01-15', 'dis-1'),
      ('pat-2', 'Климов Александр Владиславович', '1990-08-22', 'Мужчина', 'klimov@email.com', 'ward-1', 'emp-2', '2024-01-16', 'dis-2'),
      ('pat-3', 'Гаврилова Алиса Ярославовна', '2010-12-10', 'Женщина', 'alice@email.com', 'ward-1', 'emp-3', '2024-01-17', 'dis-4'),
      ('pat-4', 'Козлова Анна Сергеевна', '1968-11-22', 'Женщина', 'kozlova@email.com', 'ward-2', 'emp-4', '2024-01-12', 'dis-7'),
      ('pat-5', 'Белов Михаил Александрович', '1948-07-05', 'Мужчина', '+7-905-555-66-77', 'ward-2', 'emp-5', '2024-01-15', 'dis-8'),
      ('pat-6', 'Иванов Максим Дмитриевич', '2003-12-10', 'Мужчина', '+7-905-111-22-33', 'ward-2', 'emp-6', '2024-01-11', 'dis-10'),
      ('pat-7', 'Кузнецова Елена Викторовна', '1960-02-28', 'Женщина', '+7-911-777-88-99', 'ward-3', 'emp-7', '2024-01-21', 'dis-13'),
      ('pat-8', 'Петрова София Артемовна', '2018-06-10', 'Женщина', '+7-921-999-00-11', 'ward-3', 'emp-8', '2024-01-23', 'dis-14'),
      ('pat-9', 'Летов Егор Дмитриевич', '2003-12-05', 'Мужчина', 'letov@email.com', 'ward-3', 'emp-9', '2024-01-11', 'dis-15'),
      ('pat-10', 'Григорьев Виктор Павлович', '1962-08-12', 'Мужчина', '+7-921-555-77-88', 'ward-4', 'emp-10', '2024-01-13', 'dis-17'),
      ('pat-11', 'Сергеева Ольга Михайловна', '1978-08-22', 'Женщина', 'sergeeva@email.com', 'ward-4', 'emp-11', '2024-01-15', 'dis-17'),
      ('pat-12', 'Леонов Александр Викторович', '1950-12-10', 'Мужчина', '+7-911-666-11-22', 'ward-4', 'emp-12', '2024-01-19', 'dis-18'),
      ('pat-13', 'Сидоров Роман Юрьевич', '1964-05-15', 'Мужчина', '+7-931-888-33-44', 'ward-5', 'emp-13', '2024-01-03', 'dis-21'),
      ('pat-14', 'Андреева Наталья Владимировна', '1976-08-22', 'Женщина', '+7-905-111-44-55', 'ward-5', 'emp-14', '2024-01-22', 'dis-22'),
      ('pat-15', 'Попов Денис Сергеевич', '1962-12-10', 'Мужчина', '+7-911-222-66-77', 'ward-5', 'emp-15', '2024-01-23', 'dis-23');
    `;

    this.db.exec(seedSQL, (err) => {
      if (err) {
        console.error("Error seeding data:", err);
      } else {
        console.log("Test data seeded successfully");
      }
    });
  }

  getDatabase(): Database {
    return this.db;
  }
}

export default new DatabaseManager();
